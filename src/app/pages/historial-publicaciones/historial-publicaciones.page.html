<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>Historial de mis publicaciones</ion-title>
    <ion-buttons slot="end">
      <ion-button slot="end" expand="block" [routerLink]="['../tabs/perfil']" > VOLVER A MI PERFIL</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>

<ion-list *ngIf="misPublicaciones.length > 0">
  <ion-item *ngFor="let pub of misPublicaciones">

    <!-- Bloque para la carta, sólo si existe pub.carta -->
    <ng-container *ngIf="pub.carta as carta">
      <ion-thumbnail slot="start" *ngIf="carta.imagen_carta" class="big-thumbnail">
        <img [src]="carta.imagen_carta" [alt]="carta.nombre">
      </ion-thumbnail>

      <ion-label>
        <h2>{{ carta.nombre || ('Carta ID ' + pub.id_carta) }}</h2>

        <p *ngIf="carta.nombre_set">
          Set: {{ carta.nombre_set }}
        </p>

        <p *ngIf="carta.rareza">
          Rareza: {{ carta.rareza }}
        </p>

        <p>
          Precio: {{ pub.precio | currency:'CLP':'symbol-narrow':'1.0-0' }}
        </p>
        <p>
          Cantidad: {{ pub.cantidad }}
        </p>
        <p *ngIf="pub.estado">
          Observación: {{ pub.estado }}
        </p>
        <p *ngIf="pub.fecha_publicacion">
          Publicado el: {{ pub.fecha_publicacion | date:'dd-MM-yyyy' }}
        </p>
      </ion-label>
    </ng-container>

    <!-- Si alguna vez llega una pub sin carta, mostramos algo básico -->
    <ng-container *ngIf="!pub.carta">
      <ion-label>
        <h2>Carta ID {{ pub.id_carta }}</h2>
        <p>
          Precio: {{ pub.precio | currency:'CLP':'symbol-narrow':'1.0-0' }}
        </p>
        <p>
          Cantidad: {{ pub.cantidad }}
        </p>
        <p *ngIf="pub.estado">
          Observación: {{ pub.estado }}
        </p>
        <p *ngIf="pub.fecha_publicacion">
          Publicado el: {{ pub.fecha_publicacion | date:'dd-MM-yyyy' }}
        </p>
      </ion-label>
    </ng-container>

    <!-- Botones de acción -->
    <div slot="end" class="actions">
      <ion-button
        size="small"
        fill="outline"
        color="primary"
        (click)="empezarEditar(pub)"
      >
        Editar publicación
      </ion-button>

      <ion-button
        size="small"
        fill="solid"
        color="danger"
        (click)="confirmarEliminar(pub)"
      >
        Eliminar publicación
      </ion-button>
    </div>

    <!-- SECCIÓN EDITABLE DEBAJO DEL ITEM (dentro del ion-item) -->
    <div
      class="edit-container"
      *ngIf="publicacionEditandoId === pub.id_publicacion"
    >
      <ion-item lines="none">
        <ion-label position="stacked">Precio</ion-label>
        <ion-input
          type="number"
          [(ngModel)]="pub.precio"
        ></ion-input>
      </ion-item>

      <ion-item lines="none">
        <ion-label position="stacked">Cantidad</ion-label>
        <ion-input
          type="number"
          min="1"
          [(ngModel)]="pub.cantidad"
        ></ion-input>
      </ion-item>

      <ion-item lines="none">
        <ion-label position="stacked">Observación</ion-label>
        <ion-textarea
          autoGrow="true"
          rows="3"
          [(ngModel)]="pub.estado"
        ></ion-textarea>
      </ion-item>

      <div class="edit-actions">
        <ion-button
          size="small"
          color="primary"
          (click)="guardarCambios(pub)"
        >
          Guardar cambios
        </ion-button>

        <ion-button
          size="small"
          fill="outline"
          color="medium"
          (click)="cancelarEdicion()"
        >
          Cancelar
        </ion-button>
      </div>
    </div>

  </ion-item>
</ion-list>

</ion-content>
